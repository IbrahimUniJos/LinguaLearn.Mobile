<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:LinguaLearn.Mobile.ViewModels"
             xmlns:models="clr-namespace:LinguaLearn.Mobile.Models"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             x:Class="LinguaLearn.Mobile.Views.Onboarding.OnboardingPage"
             Title="Welcome to LinguaLearn"
             x:DataType="vm:OnboardingViewModel"
             BackgroundColor="{AppThemeBinding Light={StaticResource BackgroundLight}, Dark={StaticResource BackgroundDark}}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- Converters -->
            <toolkit:IsNotNullConverter x:Key="IsNotNullConverter" />
            <toolkit:InvertedBoolConverter x:Key="InvertedBoolConverter" />
            
            <!-- Step Card Style -->
            <Style x:Key="StepCardStyle" TargetType="Border">
                <Setter Property="BackgroundColor" Value="{AppThemeBinding Light={StaticResource SurfaceLight}, Dark={StaticResource SurfaceDark}}" />
                <Setter Property="Stroke" Value="{AppThemeBinding Light={StaticResource OutlineLight}, Dark={StaticResource OutlineDark}}" />
                <Setter Property="StrokeThickness" Value="1" />
                <Setter Property="StrokeShape" Value="RoundRectangle 12" />
                <Setter Property="Padding" Value="20" />
                <Setter Property="Margin" Value="0,10" />
            </Style>
            
            <!-- Progress Bar Style -->
            <Style x:Key="OnboardingProgressStyle" TargetType="ProgressBar">
                <Setter Property="ProgressColor" Value="{StaticResource Primary}" />
                <Setter Property="HeightRequest" Value="6" />
                <Setter Property="Margin" Value="0,10,0,20" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <ScrollView>
        <Grid Padding="20" RowSpacing="20">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />  <!-- Header -->
                <RowDefinition Height="Auto" />  <!-- Progress -->
                <RowDefinition Height="*" />     <!-- Content -->
                <RowDefinition Height="Auto" />  <!-- Navigation -->
                <RowDefinition Height="Auto" />  <!-- Error/Loading -->
            </Grid.RowDefinitions>

            <!-- Header Section -->
            <StackLayout Grid.Row="0" Spacing="15">
                <Image Source="app_logo.png" 
                       HeightRequest="80" 
                       WidthRequest="80" 
                       HorizontalOptions="Center" />
                
                <Label Text="Welcome to LinguaLearn!" 
                       FontSize="28" 
                       FontAttributes="Bold" 
                       HorizontalOptions="Center" 
                       HorizontalTextAlignment="Center"
                       TextColor="{AppThemeBinding Light={StaticResource OnSurfaceLight}, Dark={StaticResource OnSurfaceDark}}" />
                
                <Label Text="{Binding StepTitle}" 
                       FontSize="20" 
                       FontAttributes="Bold" 
                       HorizontalOptions="Center" 
                       HorizontalTextAlignment="Center"
                       TextColor="{StaticResource Primary}" />
                
                <Label Text="{Binding StepDescription}" 
                       FontSize="14" 
                       HorizontalOptions="Center" 
                       HorizontalTextAlignment="Center"
                       TextColor="{AppThemeBinding Light={StaticResource OnSurfaceVariantLight}, Dark={StaticResource OnSurfaceVariantDark}}" />
            </StackLayout>

            <!-- Progress Indicator -->
            <StackLayout Grid.Row="1" Spacing="10">
                <Label Text="{Binding ProgressText}" 
                       FontSize="12" 
                       HorizontalOptions="Center"
                       TextColor="{AppThemeBinding Light={StaticResource OnSurfaceVariantLight}, Dark={StaticResource OnSurfaceVariantDark}}" />
                
                <ProgressBar Progress="{Binding ProgressValue}" 
                             Style="{StaticResource OnboardingProgressStyle}" />
            </StackLayout>

            <!-- Content Area -->
            <ContentView Grid.Row="2">
                <StackLayout>
                    
                    <!-- Step 1: Language Selection -->
                    <Border IsVisible="{Binding IsStep1}" Style="{StaticResource StepCardStyle}">
                        <StackLayout Spacing="20">
                            <Label Text="Select Your Native Language" 
                                   FontSize="16" 
                                   FontAttributes="Bold"
                                   TextColor="{AppThemeBinding Light={StaticResource OnSurfaceLight}, Dark={StaticResource OnSurfaceDark}}" />
                            
                            <Picker ItemsSource="{Binding AvailableLanguages}"
                                    SelectedItem="{Binding SelectedNativeLanguage}"
                                    ItemDisplayBinding="{Binding Name}"
                                    Title="Choose your native language"
                                    BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceLight}, Dark={StaticResource SurfaceDark}}"
                                    TextColor="{AppThemeBinding Light={StaticResource OnSurfaceLight}, Dark={StaticResource OnSurfaceDark}}" />
                            
                            <Label Text="Select Language to Learn" 
                                   FontSize="16" 
                                   FontAttributes="Bold"
                                   TextColor="{AppThemeBinding Light={StaticResource OnSurfaceLight}, Dark={StaticResource OnSurfaceDark}}" />
                            
                            <Picker ItemsSource="{Binding AvailableLanguages}"
                                    SelectedItem="{Binding SelectedTargetLanguage}"
                                    ItemDisplayBinding="{Binding Name}"
                                    Title="Choose language to learn"
                                    BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceLight}, Dark={StaticResource SurfaceDark}}"
                                    TextColor="{AppThemeBinding Light={StaticResource OnSurfaceLight}, Dark={StaticResource OnSurfaceDark}}" />
                        </StackLayout>
                    </Border>

                    <!-- Step 2: Learning Preferences -->
                    <Border IsVisible="{Binding IsStep2}" Style="{StaticResource StepCardStyle}">
                        <StackLayout Spacing="20">
                            <Label Text="Difficulty Level" 
                                   FontSize="16" 
                                   FontAttributes="Bold"
                                   TextColor="{AppThemeBinding Light={StaticResource OnSurfaceLight}, Dark={StaticResource OnSurfaceDark}}" />
                            
                            <Picker ItemsSource="{Binding AvailableDifficultyLevels}"
                                    SelectedItem="{Binding SelectedDifficultyLevel}"
                                    Title="Choose your difficulty level"
                                    BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceLight}, Dark={StaticResource SurfaceDark}}"
                                    TextColor="{AppThemeBinding Light={StaticResource OnSurfaceLight}, Dark={StaticResource OnSurfaceDark}}" />
                            
                            <Label Text="Pronunciation Sensitivity" 
                                   FontSize="16" 
                                   FontAttributes="Bold"
                                   TextColor="{AppThemeBinding Light={StaticResource OnSurfaceLight}, Dark={StaticResource OnSurfaceDark}}" />
                            
                            <Picker ItemsSource="{Binding AvailablePronunciationSensitivities}"
                                    SelectedItem="{Binding SelectedPronunciationSensitivity}"
                                    Title="Choose pronunciation sensitivity"
                                    BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceLight}, Dark={StaticResource SurfaceDark}}"
                                    TextColor="{AppThemeBinding Light={StaticResource OnSurfaceLight}, Dark={StaticResource OnSurfaceDark}}" />
                            
                            <Label Text="How sensitive should pronunciation checking be?" 
                                   FontSize="12"
                                   TextColor="{AppThemeBinding Light={StaticResource OnSurfaceVariantLight}, Dark={StaticResource OnSurfaceVariantDark}}" />
                        </StackLayout>
                    </Border>

                    <!-- Step 3: Notifications & Goals -->
                    <Border IsVisible="{Binding IsStep3}" Style="{StaticResource StepCardStyle}">
                        <StackLayout Spacing="20">
                            <Label Text="Notifications" 
                                   FontSize="16" 
                                   FontAttributes="Bold"
                                   TextColor="{AppThemeBinding Light={StaticResource OnSurfaceLight}, Dark={StaticResource OnSurfaceDark}}" />
                            
                            <StackLayout Orientation="Horizontal" Spacing="10">
                                <Switch IsToggled="{Binding DailyReminderEnabled}" 
                                        OnColor="{StaticResource Primary}" />
                                <Label Text="Daily reminders" 
                                       VerticalOptions="Center"
                                       TextColor="{AppThemeBinding Light={StaticResource OnSurfaceLight}, Dark={StaticResource OnSurfaceDark}}" />
                            </StackLayout>
                            
                            <StackLayout IsVisible="{Binding DailyReminderEnabled}" Spacing="10">
                                <Label Text="Reminder Time" 
                                       FontSize="14" 
                                       FontAttributes="Bold"
                                       TextColor="{AppThemeBinding Light={StaticResource OnSurfaceLight}, Dark={StaticResource OnSurfaceDark}}" />
                                <TimePicker Time="{Binding DailyReminderTime}"
                                            BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceLight}, Dark={StaticResource SurfaceDark}}"
                                            TextColor="{AppThemeBinding Light={StaticResource OnSurfaceLight}, Dark={StaticResource OnSurfaceDark}}" />
                            </StackLayout>
                            
                            <Label Text="Learning Goals" 
                                   FontSize="16" 
                                   FontAttributes="Bold" 
                                   Margin="0,20,0,0"
                                   TextColor="{AppThemeBinding Light={StaticResource OnSurfaceLight}, Dark={StaticResource OnSurfaceDark}}" />
                            
                            <StackLayout Spacing="10">
                                <Label Text="{Binding WeeklyGoal, StringFormat='Lessons per week: {0}'}" 
                                       FontSize="14"
                                       TextColor="{AppThemeBinding Light={StaticResource OnSurfaceLight}, Dark={StaticResource OnSurfaceDark}}" />
                                <Slider Value="{Binding WeeklyGoal}" 
                                        Minimum="1" 
                                        Maximum="21" 
                                        ThumbColor="{StaticResource Primary}"
                                        MinimumTrackColor="{StaticResource Primary}" />
                            </StackLayout>
                            
                            <StackLayout Orientation="Horizontal" Spacing="10">
                                <Switch IsToggled="{Binding SoundEnabled}" 
                                        OnColor="{StaticResource Primary}" />
                                <Label Text="Sound effects" 
                                       VerticalOptions="Center"
                                       TextColor="{AppThemeBinding Light={StaticResource OnSurfaceLight}, Dark={StaticResource OnSurfaceDark}}" />
                            </StackLayout>
                            
                            <StackLayout Orientation="Horizontal" Spacing="10">
                                <Switch IsToggled="{Binding VibrationEnabled}" 
                                        OnColor="{StaticResource Primary}" />
                                <Label Text="Vibration feedback" 
                                       VerticalOptions="Center"
                                       TextColor="{AppThemeBinding Light={StaticResource OnSurfaceLight}, Dark={StaticResource OnSurfaceDark}}" />
                            </StackLayout>
                        </StackLayout>
                    </Border>

                    <!-- Step 4: Theme & Final Setup -->
                    <Border IsVisible="{Binding IsStep4}" Style="{StaticResource StepCardStyle}">
                        <StackLayout Spacing="20">
                            <Label Text="App Theme" 
                                   FontSize="16" 
                                   FontAttributes="Bold"
                                   TextColor="{AppThemeBinding Light={StaticResource OnSurfaceLight}, Dark={StaticResource OnSurfaceDark}}" />
                            
                            <Picker ItemsSource="{Binding AvailableThemes}"
                                    SelectedItem="{Binding SelectedTheme}"
                                    Title="Choose your preferred theme"
                                    BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceLight}, Dark={StaticResource SurfaceDark}}"
                                    TextColor="{AppThemeBinding Light={StaticResource OnSurfaceLight}, Dark={StaticResource OnSurfaceDark}}" />
                            
                            <Label Text="You're all set!" 
                                   FontSize="18" 
                                   FontAttributes="Bold" 
                                   HorizontalOptions="Center"
                                   Margin="0,20,0,0"
                                   TextColor="{StaticResource Primary}" />
                            
                            <Label Text="We've customized LinguaLearn based on your preferences. You can always change these settings later in your profile." 
                                   FontSize="14" 
                                   HorizontalOptions="Center" 
                                   HorizontalTextAlignment="Center"
                                   TextColor="{AppThemeBinding Light={StaticResource OnSurfaceVariantLight}, Dark={StaticResource OnSurfaceVariantDark}}" />
                        </StackLayout>
                    </Border>
                    
                </StackLayout>
            </ContentView>

            <!-- Navigation Buttons -->
            <Grid Grid.Row="3" ColumnSpacing="15" Margin="0,20,0,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                
                <!-- Previous Button -->
                <Button Grid.Column="0"
                        Text="Previous"
                        Command="{Binding PreviousStepCommand}"
                        IsVisible="{Binding CanGoPrevious}"
                        Style="{StaticResource SecondaryButtonStyle}" />
                
                <!-- Skip Button -->
                <Button Grid.Column="1"
                        Text="Skip for now"
                        Command="{Binding SkipOnboardingCommand}"
                        Style="{StaticResource TextButtonStyle}" />
                
                <!-- Next Button -->
                <Button Grid.Column="2"
                        Text="Next"
                        Command="{Binding NextStepCommand}"
                        IsVisible="{Binding CanGoNext}"
                        Style="{StaticResource PrimaryButtonStyle}" />
                
                <!-- Complete Button -->
                <Button Grid.Column="2"
                        Text="Complete Setup"
                        Command="{Binding CompleteOnboardingCommand}"
                        IsVisible="{Binding CanComplete}"
                        Style="{StaticResource PrimaryButtonStyle}" />
            </Grid>

            <!-- Error Message & Activity Indicator -->
            <StackLayout Grid.Row="4" Spacing="10" Margin="0,20,0,0">
                <Label Text="{Binding ErrorMessage}" 
                       IsVisible="{Binding ErrorMessage, Converter={StaticResource IsNotNullConverter}}"
                       TextColor="{StaticResource Error}"
                       HorizontalOptions="Center"
                       HorizontalTextAlignment="Center" />
                
                <ActivityIndicator IsRunning="{Binding IsBusy}" 
                                   IsVisible="{Binding IsBusy}"
                                   Color="{StaticResource Primary}"
                                   HorizontalOptions="Center" />
            </StackLayout>
        </Grid>
    </ScrollView>
</ContentPage>